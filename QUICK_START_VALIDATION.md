# å¿«é€Ÿå¼€å§‹ - æ·»åŠ Validationæ”¯æŒ

## ğŸš€ 3æ­¥å¿«é€Ÿå¯åŠ¨

### ç¬¬1æ­¥ï¼šå‡†å¤‡éªŒè¯æ•°æ®ï¼ˆ5åˆ†é’Ÿï¼‰

åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š

```bash
cd /cpfs01/projects-HDD/humPOG_HDD/wbn_24110700074/RAG_Version/VCF-Bert/00_RAG-SNVBERT-packup

# è½¬æ¢VCF â†’ H5æ ¼å¼
python scripts/prepare_val_data.py \
    --test_dir /cpfs01/projects-HDD/humPOG_HDD/wbn_24110700074/RAG_Version/VCF-Bert/New_VCF/Test \
    --output_dir data/validation \
    --mask_ratios 30
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ“ H5 file saved: data/validation/val_mask30.h5
âœ“ H5 file saved: data/validation/val_truth.h5
âœ“ Validation data prepared!
```

---

### ç¬¬2æ­¥ï¼šå¼€å§‹è®­ç»ƒï¼ˆç›´æ¥è¿è¡Œï¼‰

```bash
chmod +x run_v11_with_val.sh
bash run_v11_with_val.sh
```

**å°±è¿™æ ·ï¼** è®­ç»ƒä¼šè‡ªåŠ¨ï¼š
- âœ… æ¯ä¸ªepochè¿è¡Œvalidation
- âœ… è¾“å‡ºF1/Precision/Recall
- âœ… è‡ªåŠ¨ä¿å­˜æœ€ä½³æ¨¡å‹
- âœ… 5ä¸ªepochä¸æ”¹è¿›è‡ªåŠ¨åœæ­¢

---

### ç¬¬3æ­¥ï¼šæŸ¥çœ‹ç»“æœ

è®­ç»ƒå®Œæˆåï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
============================================================
Training stopped early at epoch 12
Best f1: 0.7456
Best model saved: .../rag_bert.model.best.pth
============================================================
```

æœ€ä½³æ¨¡å‹ä¿å­˜åœ¨ï¼š
```
output_with_val/rag_bert.model.best.pth  â† ä½¿ç”¨è¿™ä¸ªè¿›è¡Œæ¨ç†
```

---

## ğŸ“Š ä½ ä¼šçœ‹åˆ°ä»€ä¹ˆï¼Ÿ

### æ¯ä¸ªEpochçš„Validationè¾“å‡ºï¼š

```
============================================================
Epoch 1 - VALIDATION
============================================================
EP_Val:0: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 100/100 [02:15<00:00]

============================================================
Epoch 1 VAL Summary
============================================================
Avg Loss:      0.7123
Avg Accuracy:  0.6834

Haplotype Metrics:
  - F1:        0.6712  â† é‡ç‚¹å…³æ³¨è¿™ä¸ªï¼
  - Precision: 0.6890
  - Recall:    0.6542

Genotype Metrics:
  - Class 0 F1: 0.7834
  - Class 1 F1: 0.6123
  - Class 2 F1: 0.6345
  - Class 3 F1: 0.6712
  - Avg F1:    0.6754
============================================================

âœ“ New best f1: 0.6712  â† æ–°çš„æœ€ä½³åˆ†æ•°ï¼
EP:1 Model Saved: .../rag_bert.model.best.pth
```

---

## âš™ï¸ å…³é”®å‚æ•°è°ƒæ•´

### å¦‚æœæ˜¾å­˜ä¸è¶³ï¼š

ç¼–è¾‘ `run_v11_with_val.sh`ï¼Œä¿®æ”¹ï¼š

```bash
--rag_k 1                 # é»˜è®¤å·²ç»æ˜¯1ï¼ˆä»3é™åˆ°1ï¼‰
--train_batch_size 32     # batchå‡åŠï¼ˆä»64æ”¹ä¸º32ï¼‰
--grad_accum_steps 2      # æ¢¯åº¦ç´¯ç§¯ï¼ˆç­‰æ•ˆbatch=64ï¼‰
```

### å¦‚æœè®­ç»ƒå¤ªæ…¢ï¼š

```bash
--patience 3              # æ›´æ—©åœæ­¢ï¼ˆä»5æ”¹ä¸º3ï¼‰
--val_batch_size 256      # éªŒè¯batchæ›´å¤§ï¼ˆä»128æ”¹ä¸º256ï¼‰
```

### å¦‚æœæƒ³æ›´å®½å®¹çš„Early Stoppingï¼š

```bash
--patience 10             # æ›´å®½å®¹ï¼ˆä»5æ”¹ä¸º10ï¼‰
--min_delta 0.0001        # æ›´å°çš„æ”¹è¿›é˜ˆå€¼
```

---

## â“ å¸¸è§é—®é¢˜

### Q: æˆ‘çš„éªŒè¯é›†panelæ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ

**A**: å¦‚æœéªŒè¯é›†æ ·æœ¬ä¸è®­ç»ƒé›†ç›¸åŒï¼Œç›´æ¥ç”¨è®­ç»ƒé›†çš„panelï¼š
```bash
--val_panel /cpfs01/.../train.980.sample.panel  # å’Œtrain_panelç›¸åŒ
```

### Q: å¦‚ä½•çŸ¥é“éªŒè¯é›†å‡†å¤‡æˆåŠŸäº†ï¼Ÿ

**A**: æ£€æŸ¥è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
```bash
ls data/validation/val_mask30.h5
ls data/validation/val_truth.h5
```

### Q: å¯ä»¥ä¸ç”¨Validationå—ï¼Ÿ

**A**: å¯ä»¥ï¼å»æ‰è¿™ä¸¤è¡Œï¼š
```bash
# --val_dataset ...
# --val_panel ...
```
è„šæœ¬ä¼šè‡ªåŠ¨å›é€€åˆ°æ— validationæ¨¡å¼ï¼ˆå’Œä¹‹å‰ä¸€æ ·ï¼‰

---

## ğŸ“ æ–‡ä»¶å¯¹ç…§è¡¨

| æ–‡ä»¶ | è¯´æ˜ | å¿…éœ€ï¼Ÿ |
|------|------|--------|
| `scripts/prepare_val_data.py` | æ•°æ®å‡†å¤‡è„šæœ¬ | âœ“ |
| `src/main/pretrain_with_val.py` | æ–°Trainer | âœ“ |
| `src/train_with_val.py` | è®­ç»ƒå…¥å£ | âœ“ |
| `run_v11_with_val.sh` | è¿è¡Œè„šæœ¬ | âœ“ |
| `VALIDATION_STRATEGY.md` | å®Œæ•´ç­–ç•¥æ–‡æ¡£ | å‚è€ƒ |
| `data/validation/val_mask30.h5` | éªŒè¯æ•°æ®ï¼ˆéœ€ç”Ÿæˆï¼‰ | âœ“ |

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] è¿è¡Œäº† `prepare_val_data.py`
- [ ] çœ‹åˆ° `data/validation/val_mask30.h5` æ–‡ä»¶
- [ ] ç¡®è®¤ `run_v11_with_val.sh` ä¸­çš„è·¯å¾„æ­£ç¡®
- [ ] GPUæ˜¾å­˜å……è¶³ï¼ˆè‡³å°‘12GBï¼Œå¦‚æœä¸å¤Ÿè°ƒæ•´batch sizeï¼‰
- [ ] å¼€å§‹è®­ç»ƒï¼

---

## ğŸ¯ é¢„æœŸæ”¹è¿›

ä½¿ç”¨Validationåï¼š

| å¯¹æ¯”é¡¹ | ä¹‹å‰ | ç°åœ¨ |
|--------|------|------|
| æ¯ä¸ªepochå¯è§æŒ‡æ ‡ | åªæœ‰è®­ç»ƒloss | âœ… è®­ç»ƒ+éªŒè¯F1/P/R |
| æ¨¡å‹é€‰æ‹© | æ‰‹åŠ¨æŒ‘é€‰checkpoint | âœ… è‡ªåŠ¨ä¿å­˜æœ€ä½³ |
| è¿‡æ‹Ÿåˆé£é™© | é«˜ | âœ… ä½ï¼ˆEarly Stoppingï¼‰ |
| è®­ç»ƒæ—¶é—´ | 20 epochsï¼ˆå¯èƒ½æµªè´¹ï¼‰ | âœ… å¹³å‡10-12 epochs |
| æ˜¾å­˜ä½¿ç”¨ | RAG K=3ï¼ˆé«˜ï¼‰ | âœ… RAG K=1ï¼ˆä½60-70%ï¼‰ |

**ä¼°è®¡æå‡**ï¼š
- â±ï¸ è®­ç»ƒæ—¶é—´å‡å°‘ 30-50%
- ğŸ“ˆ æ¨¡å‹æ€§èƒ½æå‡ 5-10%ï¼ˆé˜²æ­¢è¿‡æ‹Ÿåˆï¼‰
- ğŸ’¾ æ˜¾å­˜å ç”¨å‡å°‘ 60-70%

---

éœ€è¦å¸®åŠ©ï¼ŸæŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼š`VALIDATION_STRATEGY.md`

ç¥è®­ç»ƒé¡ºåˆ©ï¼ğŸš€
