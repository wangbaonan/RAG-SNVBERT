# AFä¿®å¤å¯è§†åŒ–è¯´æ˜

## ğŸ¨ é—®é¢˜å¯è§†åŒ–

### ä¿®å¤å‰: AFä¿¡æ¯ä¸¥é‡ç¨€é‡Š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Token Embedding: 192ç»´                                     â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 99.5% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                    Concat with AF
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Token: 192ç»´  â”‚ AF: 1ç»´                                     â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚ â–Œ 0.5%                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                 Linear(193 â†’ 192)
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èåˆå: 192ç»´                                               â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (~99% token) â”‚
â”‚                                                 (~1% AF)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœ: AFä¿¡æ¯å‡ ä¹å®Œå…¨è¢«ç¨€é‡Š!
```

### ä¿®å¤å: AFä¿¡æ¯å®Œæ•´ä¿ç•™

```
Token Embedding        Positional Embedding      AF Embedding
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 192ç»´        â”‚      â”‚ 192ç»´        â”‚      â”‚ 192ç»´        â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
â”‚              â”‚      â”‚              â”‚      â”‚              â”‚
â”‚ 100%         â”‚      â”‚ 100%         â”‚      â”‚ 100%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             ADD
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ èåˆå: 192ç»´    â”‚
                    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
                    â”‚                  â”‚
                    â”‚ 33% + 33% + 33%  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœ: Tokenã€Positionã€AFä¸‰è€…ç­‰æƒé‡!
```

---

## ğŸ”„ Reference AFé—®é¢˜å¯è§†åŒ–

### ä¿®å¤å‰: Referenceä¸¢å¤±çœŸå®AF

```
Reference Panel (çœŸå®æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Variant 1: AF = 0.02 (rare)        â”‚
â”‚ Variant 2: AF = 0.45 (common)      â”‚
â”‚ Variant 3: AF = 0.01 (ultra-rare)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ é¢„ç¼–ç 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ åªç”¨tokensï¼Œä¸ç”¨AF               â”‚
â”‚ ref_emb = embedding(tokens)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å­˜å‚¨åˆ°FAISS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reference embeddings (æ— AFä¿¡æ¯)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ æ£€ç´¢åèåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ ç”¨Queryçš„AFè€ŒéReferenceçš„AF     â”‚
â”‚ ref_fused = fusion(ref_emb,        â”‚
â”‚                    query_pos,      â”‚
â”‚                    query_af=0.45)  â”‚ â† é”™è¯¯!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœ: Reference AF = 0.02 è¢« Query AF = 0.45 è¦†ç›–
      æ¨¡å‹è¯¯åˆ¤: rare variant â†’ common variant
```

### ä¿®å¤å: Referenceä¿ç•™çœŸå®AF

```
Reference Panel (çœŸå®æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Variant 1: AF = 0.02 (rare)        â”‚
â”‚ Variant 2: AF = 0.45 (common)      â”‚
â”‚ Variant 3: AF = 0.01 (ultra-rare)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ é¢„ç¼–ç 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ä½¿ç”¨çœŸå®AF                       â”‚
â”‚ ref_af[0] = 0.02                   â”‚
â”‚ ref_af[1] = 0.45                   â”‚
â”‚ ref_af[2] = 0.01                   â”‚
â”‚                                    â”‚
â”‚ ref_emb = embedding(tokens,        â”‚
â”‚                     af=ref_af)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å­˜å‚¨åˆ°FAISS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reference embeddings (å«çœŸå®AF)    â”‚
â”‚ - Var1 emb: åŒ…å«AF=0.02ä¿¡æ¯        â”‚
â”‚ - Var2 emb: åŒ…å«AF=0.45ä¿¡æ¯        â”‚
â”‚ - Var3 emb: åŒ…å«AF=0.01ä¿¡æ¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ æ£€ç´¢å
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Reference AFå·²ç»åœ¨embeddingä¸­    â”‚
â”‚ ä¸éœ€è¦é¢å¤–æ·»åŠ !                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœ: Referenceä¿æŒçœŸå®AFä¿¡æ¯
      æ¨¡å‹æ­£ç¡®è¯†åˆ«: rare vs common
```

---

## ğŸ” ç‰¹å¾ç©ºé—´å¯¹é½å¯è§†åŒ–

### ä¿®å¤å‰: ç‰¹å¾ç©ºé—´ä¸ä¸€è‡´

```
Queryæµç¨‹:
  tokens â†’ embedding â†’ emb_fusion(pos, af) â†’ ç‰¹å¾ç©ºé—´A
                                              â†“
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ Query   â”‚
                                          â”‚ Space A â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Referenceæµç¨‹:
  tokens â†’ embedding â†’ (æ— fusion) â†’ ç‰¹å¾ç©ºé—´B
                                    â†“
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚Referenceâ”‚
                                â”‚ Space B â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

èåˆ:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   +   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Query   â”‚       â”‚Referenceâ”‚
  â”‚ Space A â”‚       â”‚ Space B â”‚  â† ä¸åŒ¹é…! ç›¸å½“äºæ¯”è¾ƒè‹¹æœå’Œæ©™å­
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                 â†“
       â””â”€â”€â”€â”€â”€â”€â”€ RAG â”€â”€â”€â”€â”€â”˜
              Fusion
                âŒ
           (è´¨é‡å·®)
```

### ä¿®å¤å: ç‰¹å¾ç©ºé—´ä¸€è‡´

```
Queryæµç¨‹:
  tokens â†’ embedding(+AF) â†’ emb_fusion(pos, af) â†’ ç‰¹å¾ç©ºé—´A
                                                   â†“
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚ Query   â”‚
                                               â”‚ Space A â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Referenceæµç¨‹:
  tokens â†’ embedding(+AF) â†’ emb_fusion(pos, af) â†’ ç‰¹å¾ç©ºé—´A
                                                   â†“
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚Referenceâ”‚
                                               â”‚ Space A â”‚  â† ç›¸åŒç©ºé—´!
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

èåˆ:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   +   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Query   â”‚       â”‚Referenceâ”‚
  â”‚ Space A â”‚       â”‚ Space A â”‚  â† åŒ¹é…! ç›¸åŒç‰¹å¾ç©ºé—´
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                 â†“
       â””â”€â”€â”€â”€â”€â”€â”€ RAG â”€â”€â”€â”€â”€â”˜
              Fusion
                âœ…
        (è´¨é‡é«˜ï¼Œå¯æ¯”è¾ƒ)
```

---

## ğŸ§® Fourier FeaturesåŸç†å¯è§†åŒ–

### ä¸ºä»€ä¹ˆéœ€è¦Fourier Features?

```
è¿ç»­å€¼ AF (0-1)
    â†“
å¦‚ä½•ç¼–ç åˆ°é«˜ç»´ç©ºé—´?

æ–¹æ¡ˆ1: ç®€å•é‡å¤ (å·®)
  AF = 0.25 â†’ [0.25, 0.25, 0.25, ...] Ã— 192
  é—®é¢˜: æ²¡æœ‰éçº¿æ€§ï¼Œè¡¨è¾¾èƒ½åŠ›å¼±

æ–¹æ¡ˆ2: MLP (ä¸­ç­‰)
  AF = 0.25 â†’ MLP(Linear-ReLU-Linear) â†’ 192ç»´
  é—®é¢˜: éœ€è¦å¤§é‡è®­ç»ƒæ•°æ®æ‰èƒ½å­¦å¥½

æ–¹æ¡ˆ3: Fourier Features (æœ€ä¼˜)
  AF = 0.25 â†’ sin/coså¤šé¢‘ç‡ç¼–ç  â†’ 192ç»´
  ä¼˜åŠ¿: è‡ªå¸¦éçº¿æ€§ï¼Œæ•°æ®æ•ˆç‡é«˜
```

### Fourier Featuresè®¡ç®—è¿‡ç¨‹

```
è¾“å…¥: AF = 0.25
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤1: å¤šé¢‘ç‡å±•å¼€                â”‚
  â”‚                                â”‚
  â”‚ freqs = [1, 2, 4, 8, 16, ...]  â”‚
  â”‚ expanded = 0.25 Ã— freqs        â”‚
  â”‚          = [0.25, 0.5, 1, ...] â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤2: Fourierå˜æ¢              â”‚
  â”‚                                â”‚
  â”‚ sin_features = sin(2Ï€ Ã— exp)   â”‚
  â”‚              = [0.71, 0, ...]  â”‚
  â”‚                                â”‚
  â”‚ cos_features = cos(2Ï€ Ã— exp)   â”‚
  â”‚              = [0.71, -1, ...] â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤3: æ‹¼æ¥                     â”‚
  â”‚                                â”‚
  â”‚ features = [sin; cos]          â”‚
  â”‚          = [0.71, 0, ...,      â”‚
  â”‚             0.71, -1, ...]     â”‚
  â”‚          shape: [64]           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤4: çº¿æ€§æŠ•å½±                 â”‚
  â”‚                                â”‚
  â”‚ output = Linear(64 â†’ 192)      â”‚
  â”‚        + LayerNorm             â”‚
  â”‚        + GELU                  â”‚
  â”‚        + Linear(192 â†’ 192)     â”‚
  â”‚                                â”‚
  â”‚ shape: [192]                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
è¾“å‡º: AF embedding [192ç»´]
```

### ä¸åŒAFå€¼çš„ç¼–ç 

```
AF = 0.01 (rare)
  â†“ Fourier Features
  [â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ ... ] 192ç»´
   â†‘ é«˜é¢‘æˆåˆ†ä¸»å¯¼

AF = 0.25 (low-frequency)
  â†“ Fourier Features
  [â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡ ... ] 192ç»´
     â†‘ ä¸­é¢‘æˆåˆ†

AF = 0.50 (common)
  â†“ Fourier Features
  [â– â– â– â– â– â–¡â–¡â–¡â–¡â–¡ ... ] 192ç»´
       â†‘ ä½é¢‘æˆåˆ†ä¸»å¯¼

ä¸åŒAF â†’ ä¸åŒé¢‘ç‡æ¨¡å¼ â†’ æ¨¡å‹å¯åŒºåˆ†!
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµå¯è§†åŒ–

### V18 Embedding RAGå®Œæ•´æµç¨‹ (ä¿®å¤å)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     åˆå§‹åŒ–é˜¶æ®µ (é¢„ç¼–ç )                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Reference Panel VCF
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ chr21:100001 A/T 0.02   â”‚ â† AFä¿¡æ¯
â”‚ chr21:100002 C/G 0.45   â”‚
â”‚ chr21:100003 G/A 0.01   â”‚
â”‚ ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æå–tokenså’ŒAF        â”‚
  â”‚ tokens: [num_haps, L] â”‚
  â”‚ AF: [L] (çœŸå®AF!)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ BERTEmbedding         â”‚
  â”‚                       â”‚
  â”‚ token_emb = Emb(tok)  â”‚
  â”‚ pos_emb = Pos(tok)    â”‚
  â”‚ af_emb = AF_Emb(AF)   â”‚ â† æ–°å¢!
  â”‚                       â”‚
  â”‚ out = tok + pos + af  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Reference Embeddings  â”‚
  â”‚ [num_haps, L, D]      â”‚
  â”‚ (å«AFä¿¡æ¯!)           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Flatten & FAISS Index â”‚
  â”‚ [num_haps, L*D]       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
      å­˜å‚¨åˆ°CPU


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      è®­ç»ƒé˜¶æ®µ (æ¯ä¸ªbatch)                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Training Sample
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sample ID: NA12878      â”‚
â”‚ Window: chr21:1M-2M     â”‚
â”‚ hap1: [0,2,1,0,...]     â”‚
â”‚ hap2: [1,0,2,1,...]     â”‚
â”‚ AF: [0.02,0.45,...]     â”‚ â† AFä¿¡æ¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚           Collate_fn (FAISSæ£€ç´¢)                    â”‚
â”‚                                                     â”‚
â”‚  1. Query Encoding                                  â”‚
â”‚     tokens â†’ embedding(+AF) â†’ query_emb [B,L,D]     â”‚
â”‚                                                     â”‚
â”‚  2. FAISS Search                                    â”‚
â”‚     query_emb.flatten â†’ FAISS.search()              â”‚
â”‚                      â†’ indices [B, K]               â”‚
â”‚                                                     â”‚
â”‚  3. Retrieve Embeddings                             â”‚
â”‚     ref_emb = ref_embeddings[indices]               â”‚
â”‚            â†’ [B, K, L, D] (å«ReferenceçœŸå®AF!)      â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
          â†“
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚              Model Forward                          â”‚
â”‚                                                     â”‚
â”‚  Query: [B, L, D] (å«Query AF)                      â”‚
â”‚  Retrieved: [B, L, D] (å«Reference AF, squeeze K)   â”‚
â”‚                                                     â”‚
â”‚  Query â†’ emb_fusion â†’ [B,L,D]    â”                  â”‚
â”‚  Retrieved â†’ emb_fusion â†’ [B,L,D]â”œâ”€ ç›¸åŒç‰¹å¾ç©ºé—´!   â”‚
â”‚                                  â”˜                  â”‚
â”‚  rag_fusion(Query, Retrieved)                       â”‚
â”‚     â†’ Fused [B, L, D]                               â”‚
â”‚                                                     â”‚
â”‚  Transformer Ã— 10 layers                            â”‚
â”‚     â†’ Output [B, L, D]                              â”‚
â”‚                                                     â”‚
â”‚  Classifiers                                        â”‚
â”‚     â†’ Predictions                                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
          â†“
      Loss & Backward


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    æ¯ä¸ªEpochå (åˆ·æ–°)                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿å­˜çš„tokenså’ŒAF      â”‚
â”‚ ref_tokens_windows    â”‚
â”‚ ref_af_windows        â”‚ â† ä¿å­˜çš„çœŸå®AF
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æœ€æ–°çš„embedding     â”‚
â”‚ é‡æ–°ç¼–ç               â”‚
â”‚                       â”‚
â”‚ ref_emb = embedding(  â”‚
â”‚     ref_tokens,       â”‚
â”‚     af=ref_af)        â”‚ â† ä¿æŒAFä¸€è‡´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°FAISSç´¢å¼•         â”‚
â”‚ æ›´æ–°å­˜å‚¨çš„embeddings  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹æ€»ç»“

### ä¿®å¤ç‚¹1: AFç¼–ç æ–¹å¼

```
ä¿®å¤å‰:                    ä¿®å¤å:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token    â”‚              â”‚ Token    â”‚ 100%
â”‚ 99.5%    â”‚              â”‚          â”‚
â”‚          â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚ Position â”‚ 100%
â”‚ AF 0.5%  â”‚              â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â†“                    â”‚ AF       â”‚ 100%
  ä¸¥é‡ç¨€é‡Š                â”‚          â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                          å„å 33%æƒé‡
```

### ä¿®å¤ç‚¹2: Reference AFæ¥æº

```
ä¿®å¤å‰:                    ä¿®å¤å:
Reference                 Reference
  â†“                         â†“
embedding (æ— AF)          embedding (çœŸå®AF=0.02)
  â†“                         â†“
å­˜å‚¨                      å­˜å‚¨
  â†“                         â†“
æ£€ç´¢                      æ£€ç´¢
  â†“                         â†“
èåˆæ—¶ç”¨Query AF (0.45)   å·²åŒ…å«æ­£ç¡®AF (0.02)
  â†“                         â†“
âŒ AFé”™è¯¯                 âœ… AFæ­£ç¡®
```

### ä¿®å¤ç‚¹3: ç‰¹å¾ç©ºé—´å¯¹é½

```
ä¿®å¤å‰:                    ä¿®å¤å:
Query:                    Query:
  emb â†’ fusion â†’ A          emb(+AF) â†’ fusion â†’ A
                              â†‘
Reference:                    ç›¸åŒæ“ä½œ
  emb â†’ (æ— fusion) â†’ B      â†“
                          Reference:
A â‰  B âŒ                    emb(+AF) â†’ fusion â†’ A

                          A = A âœ…
```

---

## ğŸš€ é¢„æœŸæ•ˆæœå¯è§†åŒ–

### Rare Variant Imputationæ”¹è¿›

```
åœºæ™¯: æ¨æ–­ä¸€ä¸ªrare variant (çœŸå®AF=0.02)

ä¿®å¤å‰:
  Query embedding: å«AFä¿¡æ¯(å¼±)
       â†“
  FAISSæ£€ç´¢
       â†“
  Retrieved: Reference (AFä¿¡æ¯ä¸¢å¤±)
       â†“
  èåˆæ—¶: ç”¨Query AF (0.45) æ›¿æ¢
       â†“
  æ¨¡å‹è®¤ä¸º: è¿™æ˜¯ä¸ªcommon variant âŒ
       â†“
  æ¨æ–­ç»“æœ: ä¸å‡†ç¡®

ä¿®å¤å:
  Query embedding: å«AFä¿¡æ¯(å¼º, Fourier)
       â†“
  FAISSæ£€ç´¢ (å€¾å‘æ‰¾ç›¸ä¼¼AF)
       â†“
  Retrieved: Reference (å«çœŸå®AF=0.02)
       â†“
  èåˆ: æ­£ç¡®è¯†åˆ«rare variant âœ…
       â†“
  æ¨¡å‹å­¦ä¹ : rareå’Œcommonçš„ä¸åŒæ¨¡å¼
       â†“
  æ¨æ–­ç»“æœ: å‡†ç¡®!


é¢„æœŸæå‡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MAF < 0.05:  F1 +2-5%          â”‚
â”‚ MAF < 0.01:  F1 +5-10% â† æœ€å¤§! â”‚
â”‚ Overall:     F1 +0.5-1%        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ç»´åº¦æ£€æŸ¥æ¸…å•

```
âœ… AFEmbedding
   è¾“å…¥: [B, L] â†’ è¾“å‡º: [B, L, D]

âœ… BERTEmbedding
   token: [B, L, D]
   pos:   [B, L, D]
   af:    [B, L, D]  â† ç›¸åŒç»´åº¦!
   out:   [B, L, D]

âœ… é¢„ç¼–ç 
   tokens: [num_haps, L]
   AF:     [num_haps, L]  â† åŒ¹é…!
   emb:    [num_haps, L, D]

âœ… Collateæ£€ç´¢
   query:     [B, L, D]
   retrieved: [B, K, L, D]

âœ… Model Forward
   query:     [B, L, D]
   retrieved: [B, L, D]  â† squeeze K
   fused:     [B, L, D]

æ‰€æœ‰ç»´åº¦å®Œç¾åŒ¹é…! âœ…
```

---

## ğŸ‰ æ€»ç»“: ä»é—®é¢˜åˆ°è§£å†³

```
ç”¨æˆ·æå‡ºé—®é¢˜
    â”‚
    â”œâ”€ "AFæ˜¯å¦æœ‰æ•ˆç”¨åˆ°?"
    â”œâ”€ "æ˜¯å¦è¿˜èƒ½å¯¹åº”åˆ°é¢‘ç‡ä¿¡æ¯?"
    â””â”€ "AFä¿¡æ¯å°†ä¸¥é‡è¢«ç¨€é‡Š"
    â”‚
    â†“
æˆ‘ä»¬å‘ç°é—®é¢˜ âœ…
    â”‚
    â”œâ”€ AFåªå 0.5%ç»´åº¦ (ä¸¥é‡ç¨€é‡Š!)
    â”œâ”€ Referenceä¸¢å¤±çœŸå®AF
    â””â”€ ç‰¹å¾ç©ºé—´ä¸å¯¹é½
    â”‚
    â†“
è®¾è®¡ä¿®å¤æ–¹æ¡ˆ
    â”‚
    â”œâ”€ Fourier Features AFç¼–ç 
    â”œâ”€ Referenceä½¿ç”¨çœŸå®AF
    â””â”€ ç¡®ä¿ç‰¹å¾ç©ºé—´ä¸€è‡´
    â”‚
    â†“
å®ç°å¹¶åº”ç”¨ä¿®å¤ âœ…
    â”‚
    â”œâ”€ æ–°å¢af_embedding.py
    â”œâ”€ ä¿®æ”¹bert.py
    â”œâ”€ ä¿®æ”¹embedding_rag_dataset.py
    â””â”€ å®Œæ•´ä»£ç å®¡æŸ¥
    â”‚
    â†“
é¢„æœŸæ˜¾è‘—æå‡
    â”‚
    â”œâ”€ Rare F1: +5-10%
    â”œâ”€ Overall F1: +0.5-1%
    â””â”€ ç«¯åˆ°ç«¯å¯å­¦ä¹ 
    â”‚
    â†“
Ready to run! ğŸš€
```

---

**åˆ›å»ºæ—¶é—´**: 2025-12-02
**æ–‡æ¡£ç”¨é€”**: å¸®åŠ©ç†è§£AFä¿®å¤çš„åŸç†å’Œæ•ˆæœ
**çŠ¶æ€**: âœ… Complete

**ç›¸å…³æ–‡æ¡£**:
- [AF_FIX_SUMMARY.md](AF_FIX_SUMMARY.md) - å¿«é€Ÿæ€»ç»“
- [COMPLETE_AF_FIX_REVIEW.md](COMPLETE_AF_FIX_REVIEW.md) - è¯¦ç»†å®¡æŸ¥
