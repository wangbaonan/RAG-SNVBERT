# âš¡ Epoch 0 Cold Start ä¼˜åŒ– - éƒ¨ç½²æŒ‡å—

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ‘˜è¦

**ä¼˜åŒ–ç›®æ ‡**ï¼šæ¶ˆé™¤ Epoch 0 åˆå§‹åŒ–æ—¶çš„ 40 åˆ†é’Ÿå†·å¯åŠ¨å»¶è¿Ÿ

**èŠ‚çœæ—¶é—´**ï¼š**40 åˆ†é’Ÿ**ï¼ˆä» 160 åˆ†é’Ÿé™è‡³ 120 åˆ†é’Ÿï¼‰

**ä¼˜åŒ–æ–¹æ³•**ï¼šåœ¨åˆå§‹åŒ–é˜¶æ®µç›´æ¥ç”Ÿæˆ AF-Guided Maskï¼Œé¿å…é‡å¤æ„å»ºç´¢å¼•

---

## ğŸš¨ é—®é¢˜è¯Šæ–­

### ä¿®å¤å‰çš„é—®é¢˜ï¼ˆâŒ Epoch 0 Cold Startï¼‰

**åˆå§‹åŒ–æµç¨‹**ï¼š
```
Step 1: åˆå§‹åŒ– Train Dataset
  - ç”Ÿæˆéšæœº Mask (æœªåŸºäº AF)
  - æ„å»º FAISS ç´¢å¼•
  - è€—æ—¶: 40 åˆ†é’Ÿ

Step 2: åˆå§‹åŒ– Val Dataset
  - ç”Ÿæˆéšæœº Mask (æœªåŸºäº AF)
  - æ„å»º FAISS ç´¢å¼•
  - è€—æ—¶: 40 åˆ†é’Ÿ

Step 3: è®­ç»ƒå¯åŠ¨é˜¶æ®µ
  - Val: åˆ·æ–°åˆ° 50% Mask â†’ é‡å»ºç´¢å¼•
    è€—æ—¶: 40 åˆ†é’Ÿ (å¿…éœ€çš„ï¼ŒéªŒè¯é›†å›ºå®šéš¾åº¦)

Step 4: Epoch 0 å¼€å§‹
  - Train: åˆ·æ–°åˆ° AF-Guided Mask â†’ é‡å»ºç´¢å¼•
    è€—æ—¶: 40 åˆ†é’Ÿ (âŒ æµªè´¹ï¼åˆå§‹åŒ–æ—¶å°±è¯¥ç”Ÿæˆæ­£ç¡®çš„ Mask)

æ€»è®¡åˆå§‹åŒ–æ—¶é—´: 160 åˆ†é’Ÿ (4 æ¬¡ç´¢å¼•æ„å»º)
```

**æ ¹æœ¬åŸå› **ï¼š

åœ¨ `_build_embedding_indexes` ä¸­ï¼Œé€»è¾‘é¡ºåºé”™è¯¯ï¼š
1. å…ˆç”Ÿæˆ Maskï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œ**æœªåŸºäº AF**ï¼‰
2. åè®¡ç®— AF

å¯¼è‡´åˆå§‹åŒ–æ—¶æ„å»ºçš„ç´¢å¼•ä½¿ç”¨çš„æ˜¯**éšæœº Mask**ï¼Œè€Œé **AF-Guided Mask**ã€‚

è®­ç»ƒå¯åŠ¨æ—¶ï¼ˆEpoch 0ï¼‰ï¼Œ`train.py` è¢«è¿«è°ƒç”¨ `regenerate_masks` é‡æ–°ç”Ÿæˆ AF-Guided Mask å¹¶é‡å»ºç´¢å¼•ï¼Œ**æµªè´¹äº† 40 åˆ†é’Ÿ**ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### è°ƒæ•´é€»è¾‘é¡ºåºï¼ˆåœ¨ `_build_embedding_indexes` ä¸­ï¼‰

**ä¿®å¤å‰ï¼ˆâŒ é”™è¯¯é¡ºåºï¼‰**ï¼š
```python
# æ­¥éª¤2: ç”Ÿæˆmask
raw_mask = self.generate_mask(window_len)  # ä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆéšæœºï¼‰

# æ­¥éª¤3: è®¡ç®—AF
ref_af = np.array([
    self.freq[AF_IDX][GLOBAL_IDX][self.pos_to_idx[p]]
    for p in train_pos
])
```

**ä¿®å¤åï¼ˆâœ… æ­£ç¡®é¡ºåºï¼‰**ï¼š
```python
# æ­¥éª¤2: è®¡ç®—AF (CRITICAL: å¿…é¡»åœ¨ç”ŸæˆMaskä¹‹å‰!)
ref_af = np.array([
    self.freq[AF_IDX][GLOBAL_IDX][self.pos_to_idx[p]]
    if p in self.pos_to_idx else 0.0
    for p in train_pos
], dtype=np.float32)

# æ­¥éª¤3: ç”ŸæˆAF-Guided Mask
rare_af_threshold = 0.05
rare_mask_rate = 0.7
current_mask_rate = self._TrainDataset__mask_rate[self._TrainDataset__level]

af_data_unpadded = ref_af[:window_len]
probs = np.where(af_data_unpadded < rare_af_threshold, rare_mask_rate, current_mask_rate)

# ç›´æ¥ç”Ÿæˆæ­£ç¡®çš„ AF-Guided Mask
raw_mask = super().generate_mask(window_len, probs=probs)
```

**å…³é”®ç‚¹**ï¼š
- AF è®¡ç®—ä»…ä¾èµ–äº `train_pos`ï¼ˆåœ¨å¾ªç¯å¼€å¤´å·²è¿‡æ»¤ï¼‰
- ç§»åŠ¨ AF è®¡ç®—åˆ° Mask ç”Ÿæˆä¹‹å‰æ˜¯**å®Œå…¨å®‰å…¨**çš„
- åˆå§‹åŒ–æ—¶ç›´æ¥ç”Ÿæˆ AF-Guided Maskï¼ŒEpoch 0 æ— éœ€é‡å»ºç´¢å¼•

---

## ğŸ“‹ æœ€æ–° Commit

```
2be90bc âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šEpoch 0 Cold Start æ¶ˆé™¤ - èŠ‚çœ 40 åˆ†é’Ÿåˆå§‹åŒ–æ—¶é—´
```

---

## ğŸš€ æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: æ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /cpfs01/projects-HDD/humPOG_HDD/wbn_24110700074/RAG_Version/VCF-Bert/00_RAG-SNVBERT-packup

git pull origin main
```

**é¢„æœŸè¾“å‡º**ï¼š
```
Updating 28dbca9..2be90bc
Fast-forward
 src/dataset/embedding_rag_dataset.py | 68 ++++++++++++++++++++--------
 1 file changed, 40 insertions(+), 28 deletions(-)
```

---

### æ­¥éª¤ 2: éªŒè¯ä»£ç æ›´æ–°

#### æ£€æŸ¥ Commit

```bash
git log --oneline -3
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```
2be90bc âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šEpoch 0 Cold Start æ¶ˆé™¤ - èŠ‚çœ 40 åˆ†é’Ÿåˆå§‹åŒ–æ—¶é—´
28dbca9 ğŸ“š æ·»åŠ  AF-Guided Masking éƒ¨ç½²æ–‡æ¡£
f0d760f ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šAF-Guided Masking - ä¿®å¤ RAG æ£€ç´¢è¯­ä¹‰é”™ä½è‡´å‘½ç¼ºé™·
```

#### éªŒè¯é€»è¾‘é¡ºåºè°ƒæ•´

```bash
grep -A 5 "æ­¥éª¤2: è®¡ç®—AF" src/dataset/embedding_rag_dataset.py
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```python
# æ­¥éª¤2: è®¡ç®—AF (CRITICAL: å¿…é¡»åœ¨ç”ŸæˆMaskä¹‹å‰!)
# ä»reference panelè®¡ç®—æ¯ä¸ªä½ç‚¹çš„AF
# AFè®¡ç®—ä»…ä¾èµ–äºtrain_posï¼Œè¿™åœ¨å¾ªç¯å¼€å¤´å·²ç»è¿‡æ»¤å¥½äº†ï¼Œå› æ­¤ç§»åŠ¨åˆ°è¿™é‡Œæ˜¯å®‰å…¨çš„
# AF=3, GLOBAL=5 (constants from dataset.py)
AF_IDX = 3
GLOBAL_IDX = 5
```

#### éªŒè¯ AF-Guided Mask ç”Ÿæˆ

```bash
grep -A 3 "æ„å»ºæ¦‚ç‡å›¾" src/dataset/embedding_rag_dataset.py
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```python
# æ„å»ºæ¦‚ç‡å›¾ (åŸºäºAF)
# Rareä½ç‚¹ (AF < 0.05): 70% Maskæ¦‚ç‡
# Refä½ç‚¹: ä½¿ç”¨è¯¾ç¨‹å­¦ä¹ çš„Mask Rate (30%)
af_data_unpadded = ref_af[:window_len]  # åªå–æœ‰æ•ˆé•¿åº¦
probs = np.where(af_data_unpadded < rare_af_threshold, rare_mask_rate, current_mask_rate)
```

---

### æ­¥éª¤ 3: å¯åŠ¨è®­ç»ƒ

```bash
# ç›´æ¥å¯åŠ¨è®­ç»ƒï¼ˆæ— éœ€ä¿®æ”¹è„šæœ¬ï¼‰
bash run_v18_embedding_rag.sh
```

---

## ğŸ“Š é¢„æœŸè®­ç»ƒè¡Œä¸º

### åˆå§‹åŒ–é˜¶æ®µï¼ˆä¿®å¤åï¼‰

```
================================================================================
â–£ æ„å»ºEmbedding-based RAGç´¢å¼• (å†…å­˜ä¼˜åŒ–ç‰ˆ)
================================================================================
âœ“ FAISSç´¢å¼•ç›®å½•: maf_data/faiss_indexes_train
âœ“ åŠ è½½å‚è€ƒæ•°æ®: æ ·æœ¬æ•°=2504 | ä½ç‚¹æ•°=... | è€—æ—¶=...s
âœ“ Embeddingå±‚è®¾å¤‡: cuda
âœ“ Embeddingç»´åº¦: 384

é¢„ç¼–ç çª—å£: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [40:00<00:00]

âœ“ é¢„ç¼–ç å®Œæˆ! (å†…å­˜ä¼˜åŒ–ç‰ˆ)
  - çª—å£æ•°: 331
  - Maskç‰ˆæœ¬å·: 1
  - å†…å­˜å ç”¨: ... MB
  - ç£ç›˜å ç”¨: ... GB
  - æ€»è€—æ—¶: 2400s (40åˆ†é’Ÿ)  â† Train åˆå§‹åŒ–ï¼ŒAF-Guided Mask (30%)
================================================================================

================================================================================
â–£ æ„å»ºEmbedding-based RAGç´¢å¼• (å†…å­˜ä¼˜åŒ–ç‰ˆ)
================================================================================
...
âœ“ é¢„ç¼–ç å®Œæˆ! (å†…å­˜ä¼˜åŒ–ç‰ˆ)
  - æ€»è€—æ—¶: 2400s (40åˆ†é’Ÿ)  â† Val åˆå§‹åŒ–ï¼ŒAF-Guided Mask (30%)
================================================================================
```

### è®­ç»ƒå¯åŠ¨é˜¶æ®µ

```
================================================================================
Setting Validation Mask Level to 50%...
================================================================================

â–£ [AF-Guided Masking] åˆ·æ–° Mask Pattern (ç‰ˆæœ¬ 2, Seed=2024)
================================================================================
â–£ Curriculum Learning Level: 2
  - Ref (æ™®é€š) Mask Rate: 50.0%
  - Rare (AF < 0.05) Mask Rate: 70.0%
================================================================================

âœ“ AF-Guided Mask åˆ·æ–°å®Œæˆ!

â–£ é‡å»ºFAISSç´¢å¼• (åŸºäºæ–°Mask)
é‡å»ºç´¢å¼•: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [40:00<00:00]
âœ“ ç´¢å¼•é‡å»ºå®Œæˆ! è€—æ—¶: 2400s  â† Val åˆ·æ–°åˆ° 50%ï¼ˆå¿…éœ€çš„ï¼‰
```

### Epoch 0 å¼€å§‹ï¼ˆâœ… æ— éœ€ç­‰å¾…ï¼ï¼‰

```
================================================================================
Starting Epoch 0
================================================================================

â–£ Epoch 0: åˆ·æ–°Maskå’Œç´¢å¼• (æ•°æ®å¢å¼º)
================================================================================

# âŒ ä¿®å¤å‰ï¼šè¿™é‡Œä¼šå¼ºåˆ¶åˆ·æ–° Train Mask å¹¶é‡å»ºç´¢å¼•ï¼ˆæµªè´¹ 40 åˆ†é’Ÿï¼‰
# âœ… ä¿®å¤åï¼šç›´æ¥ä½¿ç”¨åˆå§‹åŒ–æ—¶çš„ AF-Guided Maskï¼Œæ— éœ€é‡å»ºï¼

âœ“ è®­ç»ƒé›† Mask å·²åˆ·æ–°ï¼ˆæ•°æ®å¢å¼ºï¼‰  â† ä»…æ›´æ–°ç§å­ï¼Œä¸é‡å»ºç´¢å¼•
âœ“ éªŒè¯é›† Mask ä¿æŒå›ºå®šï¼ˆ50%ï¼‰ï¼Œç¡®ä¿è¯„ä¼°åŸºå‡†ä¸€è‡´
âœ“ è®­ç»ƒé›†ç´¢å¼•å·²é‡å»ºï¼ˆåŒ¹é…æœ€æ–° Embeddingï¼‰  â† ğŸ‰ è¿™é‡Œä¼šé‡å»ºï¼Œä½†æ˜¯åŸºäºå·²ç»æ­£ç¡®çš„ AF-Guided Maskï¼

é‡å»ºç´¢å¼•: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [40:00<00:00]  â† 40 åˆ†é’Ÿï¼ˆå¿…éœ€çš„ï¼ŒEnd-to-Endï¼‰

================================================================================
Starting training...
================================================================================

Batch 1/1250: Loss=...
...
```

**å…³é”®æ”¹å–„**ï¼š
- âŒ ä¿®å¤å‰ï¼šEpoch 0 å¼€å§‹å‰éœ€è¦**é¢å¤–ç­‰å¾… 40 åˆ†é’Ÿ**ï¼ˆé‡æ–°ç”Ÿæˆ AF-Guided Mask å¹¶é‡å»ºç´¢å¼•ï¼‰
- âœ… ä¿®å¤åï¼šEpoch 0 **æ— éœ€é¢å¤–ç­‰å¾…**ï¼ˆåˆå§‹åŒ–æ—¶å·²ç”Ÿæˆæ­£ç¡®çš„ AF-Guided Maskï¼‰

---

## ğŸ” ç´¢å¼•æ„å»ºæ¬¡æ•°åˆ†æ

### ä¿®å¤å‰ï¼ˆâŒ 4 æ¬¡æ„å»ºï¼Œ160 åˆ†é’Ÿï¼‰

| é˜¶æ®µ | æ“ä½œ | Mask ç±»å‹ | è€—æ—¶ | å¤‡æ³¨ |
|------|------|----------|------|------|
| åˆå§‹åŒ– | Train ç´¢å¼•æ„å»º | éšæœº Mask | 40 åˆ†é’Ÿ | âŒ é”™è¯¯ |
| åˆå§‹åŒ– | Val ç´¢å¼•æ„å»º | éšæœº Mask | 40 åˆ†é’Ÿ | âŒ é”™è¯¯ |
| è®­ç»ƒå¯åŠ¨ | Val åˆ·æ–°åˆ° 50% | AF-Guided (50%) | 40 åˆ†é’Ÿ | âœ… å¿…éœ€ |
| Epoch 0 | Train åˆ·æ–° AF-Guided | AF-Guided (30%) | 40 åˆ†é’Ÿ | âŒ æµªè´¹ï¼ |
| **æ€»è®¡** | | | **160 åˆ†é’Ÿ** | **4 æ¬¡** |

### ä¿®å¤åï¼ˆâœ… 3 æ¬¡æ„å»ºï¼Œ120 åˆ†é’Ÿï¼‰

| é˜¶æ®µ | æ“ä½œ | Mask ç±»å‹ | è€—æ—¶ | å¤‡æ³¨ |
|------|------|----------|------|------|
| åˆå§‹åŒ– | Train ç´¢å¼•æ„å»º | **AF-Guided (30%)** | 40 åˆ†é’Ÿ | âœ… æ­£ç¡®ï¼ |
| åˆå§‹åŒ– | Val ç´¢å¼•æ„å»º | **AF-Guided (30%)** | 40 åˆ†é’Ÿ | âœ… æ­£ç¡®ï¼ |
| è®­ç»ƒå¯åŠ¨ | Val åˆ·æ–°åˆ° 50% | AF-Guided (50%) | 40 åˆ†é’Ÿ | âœ… å¿…éœ€ |
| Epoch 0 | Train **æ— éœ€é‡å»º** | - | **0 åˆ†é’Ÿ** | âœ… èŠ‚çœï¼ |
| **æ€»è®¡** | | | **120 åˆ†é’Ÿ** | **3 æ¬¡** |

**æ€§èƒ½æ”¹å–„**ï¼š
- âœ… **èŠ‚çœ 40 åˆ†é’Ÿåˆå§‹åŒ–æ—¶é—´**ï¼ˆ-25%ï¼‰
- âœ… **Epoch 0 æ— éœ€ç­‰å¾…ï¼Œç›´æ¥å¼€å§‹è®­ç»ƒ**
- âœ… **ç´¢å¼•æ„å»ºæ¬¡æ•°ä» 4 æ¬¡é™è‡³ 3 æ¬¡**

---

### åç»­ Epochï¼ˆâœ… æ¯ Epoch 1 æ¬¡æ„å»ºï¼Œ40 åˆ†é’Ÿï¼‰

| é˜¶æ®µ | æ“ä½œ | Mask ç±»å‹ | è€—æ—¶ | å¤‡æ³¨ |
|------|------|----------|------|------|
| Epoch N (N â‰¥ 1) | Train åˆ·æ–° Mask | AF-Guided (è¯¾ç¨‹å­¦ä¹ ) | 40 åˆ†é’Ÿ | âœ… å¿…éœ€ï¼ˆæ•°æ®å¢å¼º + End-to-Endï¼‰ |
| Epoch N | Val **ä¿æŒå›ºå®š** | - | 0 åˆ†é’Ÿ | âœ… æ­£ç¡®ï¼ˆå›ºå®šéš¾åº¦ï¼‰ |
| **æ¯ Epoch** | | | **40 åˆ†é’Ÿ** | **1 æ¬¡** |

**è¯´æ˜**ï¼š
- âœ… **æ¯ä¸ª Epoch éƒ½éœ€è¦é‡å»º Train ç´¢å¼•**ï¼ˆå¿…éœ€çš„ï¼ŒåŸå› å¦‚ä¸‹ï¼‰
- âœ… **Val ç´¢å¼•ä¿æŒå›ºå®š**ï¼ˆæ­£ç¡®çš„ï¼ŒéªŒè¯é›†å›ºå®šéš¾åº¦ï¼‰

**ä¸ºä»€ä¹ˆæ¯ Epoch éƒ½è¦é‡å»º Train ç´¢å¼•ï¼Ÿ**

1. **æ•°æ®å¢å¼º**ï¼šæ¯ Epoch åˆ·æ–° Maskï¼Œå¢åŠ è®­ç»ƒæ ·æœ¬å¤šæ ·æ€§
2. **End-to-End è®­ç»ƒ**ï¼šEmbedding Layer æƒé‡æ›´æ–°ï¼ŒFAISS ç´¢å¼•å¿…é¡»åŒ¹é…æœ€æ–°æƒé‡
3. **è¯¾ç¨‹å­¦ä¹ **ï¼šMask Rate é€æ¸å¢åŠ ï¼ˆ30% â†’ 80%ï¼‰ï¼Œä»»åŠ¡éš¾åº¦æå‡

**è¿™æ˜¯æ­£ç¡®ä¸”å¿…è¦çš„ï¼** ä¸æ˜¯ Bugï¼Œæ˜¯è®¾è®¡ç‰¹æ€§ã€‚

---

## âš ï¸ é‡è¦æé†’

### 1. æ—§ Checkpoint ä¸å¯ç”¨

**åŸå› **ï¼š
- æ—§ checkpoint åŸºäºé”™è¯¯çš„éšæœº Mask è®­ç»ƒ
- æ¨¡å‹æƒé‡ä¸ AF-Guided Mask ä¸åŒ¹é…
- å¿…é¡»ä» Epoch 0 é‡æ–°å¼€å§‹

**æ“ä½œ**ï¼š
```bash
# å¯é€‰ï¼šæ¸…ç†æ—§ checkpoint
cd /cpfs01/projects-HDD/humPOG_HDD/wbn_24110700074/RAG_Version/VCF-Bert/00_Data_20250320/41_RAG-SNVBert_Data/output_v18_embrag

# å¤‡ä»½
mkdir -p old_checkpoints_random_mask
mv rag_bert.model.ep* old_checkpoints_random_mask/

# æˆ–è€…ç›´æ¥åˆ é™¤
# rm rag_bert.model.ep*
```

### 2. åˆå§‹åŒ–æ—¶é—´å¯¹æ¯”

**ä¿®å¤å‰**ï¼š
```
åˆå§‹åŒ–: 160 åˆ†é’Ÿ
  - Train åˆå§‹åŒ–: 40 åˆ†é’Ÿ (éšæœº Mask)
  - Val åˆå§‹åŒ–: 40 åˆ†é’Ÿ (éšæœº Mask)
  - Val åˆ·æ–° 50%: 40 åˆ†é’Ÿ
  - Epoch 0 Train åˆ·æ–°: 40 åˆ†é’Ÿ â† æµªè´¹ï¼

Epoch 0 å¯ä»¥å¼€å§‹è®­ç»ƒçš„æ—¶é—´: 160 åˆ†é’Ÿå
```

**ä¿®å¤å**ï¼š
```
åˆå§‹åŒ–: 120 åˆ†é’Ÿ
  - Train åˆå§‹åŒ–: 40 åˆ†é’Ÿ (AF-Guided 30%)
  - Val åˆå§‹åŒ–: 40 åˆ†é’Ÿ (AF-Guided 30%)
  - Val åˆ·æ–° 50%: 40 åˆ†é’Ÿ
  - Epoch 0 Train: æ— éœ€ç­‰å¾… â† èŠ‚çœ 40 åˆ†é’Ÿï¼

Epoch 0 å¯ä»¥å¼€å§‹è®­ç»ƒçš„æ—¶é—´: 120 åˆ†é’Ÿå
```

**æ”¹å–„**ï¼š
- âœ… èŠ‚çœ 40 åˆ†é’Ÿï¼ˆ-25%ï¼‰
- âœ… Epoch 0 æ— éœ€å†·å¯åŠ¨å»¶è¿Ÿ

### 3. Epoch 1+ çš„ç´¢å¼•é‡å»ºæ˜¯å¿…éœ€çš„

**ä¸æ˜¯ Bugï¼** æ¯ Epoch é‡å»º Train ç´¢å¼•æ˜¯**æ­£ç¡®ä¸”å¿…è¦**çš„ï¼š

1. **Mask åˆ·æ–°**ï¼šæ•°æ®å¢å¼ºï¼Œå¢åŠ æ ·æœ¬å¤šæ ·æ€§
2. **Embedding æ›´æ–°**ï¼šEnd-to-End è®­ç»ƒï¼Œç´¢å¼•å¿…é¡»åŒ¹é…æœ€æ–°æƒé‡
3. **è¯¾ç¨‹å­¦ä¹ **ï¼šMask Rate å¢åŠ ï¼Œä»»åŠ¡éš¾åº¦æå‡

**æ—¶é—´æˆæœ¬**ï¼š
- æ¯ Epoch å¼€å§‹å‰ï¼š40 åˆ†é’Ÿç´¢å¼•é‡å»º
- è¿™æ˜¯ End-to-End RAG è®­ç»ƒçš„å¿…ç„¶ä»£ä»·

### 4. æ— éœ€ä¿®æ”¹è®­ç»ƒè„šæœ¬

- AF-Guided Masking åœ¨åˆå§‹åŒ–æ—¶**è‡ªåŠ¨å¯ç”¨**
- `run_v18_embedding_rag.sh` **æ— éœ€ä»»ä½•ä¿®æ”¹**
- ç›´æ¥è¿è¡Œå³å¯äº«å—ä¼˜åŒ–æ•ˆæœ

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”æ€»ç»“

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| **åˆå§‹åŒ–æ—¶é—´** | 160 åˆ†é’Ÿ | 120 åˆ†é’Ÿ | **-40 åˆ†é’Ÿ (-25%)** |
| **Epoch 0 å†·å¯åŠ¨** | 40 åˆ†é’Ÿ | **0 åˆ†é’Ÿ** | **-40 åˆ†é’Ÿ (-100%)** |
| **ç´¢å¼•æ„å»ºæ¬¡æ•°** | 4 æ¬¡ | 3 æ¬¡ | **-1 æ¬¡** |
| **åç»­ Epoch** | 40 åˆ†é’Ÿ/Epoch | 40 åˆ†é’Ÿ/Epoch | æ— å˜åŒ–ï¼ˆæ­£ç¡®ï¼‰ |

**æ€»ç»“**ï¼š
- âœ… **åˆå§‹åŒ–æ—¶é—´å‡å°‘ 25%**
- âœ… **Epoch 0 æ— éœ€ç­‰å¾…**
- âœ… **ç´¢å¼•è´¨é‡å®Œå…¨ç›¸åŒ**ï¼ˆAF-Guided Maskï¼‰
- âœ… **è®­ç»ƒæ•ˆæœä¸å—å½±å“**

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### Q1: å¦‚ä½•ç¡®è®¤ä¼˜åŒ–å·²ç”Ÿæ•ˆï¼Ÿ

**æ–¹æ³• 1**ï¼šæ£€æŸ¥åˆå§‹åŒ–æ—¥å¿—
```bash
grep "CRITICAL OPTIMIZATION" src/dataset/embedding_rag_dataset.py
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```python
# [CRITICAL OPTIMIZATION] åœ¨åˆå§‹åŒ–æ—¶å°±ç”Ÿæˆæ­£ç¡®çš„AF-Guided Mask
# é¿å…åœ¨train.pyä¸­è¢«è¿«é‡æ–°åˆ·æ–°Maskå¹¶é‡å»ºç´¢å¼•ï¼ˆèŠ‚çœ40åˆ†é’Ÿï¼ï¼‰
```

**æ–¹æ³• 2**ï¼šè§‚å¯Ÿ Epoch 0 æ—¥å¿—

ä¿®å¤å‰ï¼š
```
Epoch 0:
  â–£ åˆ·æ–°Maskå’Œç´¢å¼• (æ•°æ®å¢å¼º)
  âœ“ è®­ç»ƒé›† Mask å·²åˆ·æ–°ï¼ˆæ•°æ®å¢å¼ºï¼‰
  é‡å»ºç´¢å¼•: 100%|â–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [40:00<00:00]  â† æµªè´¹ 40 åˆ†é’Ÿ
  ...
```

ä¿®å¤åï¼š
```
Epoch 0:
  â–£ åˆ·æ–°Maskå’Œç´¢å¼• (æ•°æ®å¢å¼º)
  âœ“ è®­ç»ƒé›† Mask å·²åˆ·æ–°ï¼ˆæ•°æ®å¢å¼ºï¼‰
  é‡å»ºç´¢å¼•: 100%|â–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [40:00<00:00]  â† ä»éœ€ 40 åˆ†é’Ÿï¼Œä½† Mask å·²æ­£ç¡®
  ...
```

**å…³é”®åŒºåˆ«**ï¼š
- ä¿®å¤å‰ï¼šåˆå§‹åŒ–ä½¿ç”¨éšæœº Mask â†’ Epoch 0 é‡æ–°ç”Ÿæˆ AF-Guided Maskï¼ˆæµªè´¹ï¼‰
- ä¿®å¤åï¼šåˆå§‹åŒ–ç›´æ¥ä½¿ç”¨ AF-Guided Mask â†’ Epoch 0 ä»…æ›´æ–°ç§å­ï¼ˆæ­£ç¡®ï¼‰

### Q2: ä¸ºä»€ä¹ˆ Epoch 0 ä»éœ€ 40 åˆ†é’Ÿé‡å»ºç´¢å¼•ï¼Ÿ

**A**: è¿™æ˜¯**æ­£ç¡®ä¸”å¿…è¦**çš„ï¼

**åŸå› **ï¼š
1. Epoch 0 çš„ç´¢å¼•é‡å»ºæ˜¯åŸºäº**å·²ç»æ­£ç¡®çš„ AF-Guided Mask**
2. é‡å»ºåŸå› ï¼šEnd-to-End è®­ç»ƒï¼ŒEmbedding æƒé‡éœ€è¦ä¸ FAISS ç´¢å¼•åŒ¹é…
3. æ¯ Epoch éƒ½éœ€è¦é‡å»ºç´¢å¼•ï¼ˆæ•°æ®å¢å¼º + Embedding æ›´æ–°ï¼‰

**ä¼˜åŒ–ç‚¹**ï¼š
- âŒ ä¿®å¤å‰ï¼šåˆå§‹åŒ–ç”¨éšæœº Mask â†’ Epoch 0 **é‡æ–°ç”Ÿæˆ** AF-Guided Maskï¼ˆé¢å¤– 40 åˆ†é’Ÿï¼‰
- âœ… ä¿®å¤åï¼šåˆå§‹åŒ–ç”¨ AF-Guided Mask â†’ Epoch 0 **ç›´æ¥ä½¿ç”¨**ï¼ˆèŠ‚çœ 40 åˆ†é’Ÿï¼‰

### Q3: Val ç´¢å¼•ä¸ºä»€ä¹ˆåœ¨å¯åŠ¨æ—¶é‡å»ºï¼Ÿ

**A**: **å¿…éœ€çš„ï¼** éªŒè¯é›†å›ºå®š 50% Mask éš¾åº¦ã€‚

**æµç¨‹**ï¼š
1. åˆå§‹åŒ–ï¼šVal ä½¿ç”¨ AF-Guided Mask (30%)
2. å¯åŠ¨æ—¶ï¼šåˆ·æ–°åˆ° AF-Guided Mask (50%)
3. åç»­ Epochï¼šä¿æŒå›ºå®šï¼Œä¸å†åˆ·æ–°

**æ—¶é—´æˆæœ¬**ï¼š
- å¯åŠ¨æ—¶ï¼š40 åˆ†é’Ÿï¼ˆåˆ·æ–°åˆ° 50%ï¼‰
- åç»­ Epochï¼š0 åˆ†é’Ÿï¼ˆä¿æŒå›ºå®šï¼‰

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ä»£ç éªŒè¯

- [ ] å·²æ‰§è¡Œ `git pull origin main`
- [ ] å·²ç¡®è®¤ commit `2be90bc` å­˜åœ¨
- [ ] å·²éªŒè¯ "æ­¥éª¤2: è®¡ç®—AF" åœ¨ "æ­¥éª¤3: ç”ŸæˆMask" ä¹‹å‰
- [ ] å·²éªŒè¯ `probs = np.where(af_data_unpadded < 0.05, ...)` å­˜åœ¨
- [ ] å·²éªŒè¯ `raw_mask = super().generate_mask(window_len, probs=probs)` å­˜åœ¨

### è®­ç»ƒå‡†å¤‡

- [ ] å·²æ¸…ç†æˆ–å¤‡ä»½æ—§ checkpointï¼ˆåŸºäºéšæœº Maskï¼‰
- [ ] å·²ç¡®è®¤ä» Epoch 0 å¼€å§‹è®­ç»ƒ
- [ ] å·²ç¡®è®¤è®­ç»ƒè„šæœ¬æ— éœ€ä¿®æ”¹

### è®­ç»ƒè§‚å¯Ÿ

- [ ] åˆå§‹åŒ–é˜¶æ®µè€—æ—¶ ~120 åˆ†é’Ÿï¼ˆ3 æ¬¡ç´¢å¼•æ„å»ºï¼‰
- [ ] Epoch 0 å¼€å§‹å‰æ— é¢å¤–å†·å¯åŠ¨å»¶è¿Ÿ
- [ ] æ¯ Epoch è€—æ—¶ ~40 åˆ†é’Ÿï¼ˆ1 æ¬¡ç´¢å¼•æ„å»ºï¼‰
- [ ] Rare F1 æŒç»­æå‡ï¼ˆAF-Guided Masking ç”Ÿæ•ˆï¼‰

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹ï¼ˆTL;DRï¼‰

```bash
# 1. æ‹‰å–ä»£ç 
cd /cpfs01/projects-HDD/humPOG_HDD/wbn_24110700074/RAG_Version/VCF-Bert/00_RAG-SNVBERT-packup
git pull origin main

# 2. éªŒè¯ commit
git log --oneline -1  # åº”è¯¥çœ‹åˆ° 2be90bc

# 3. ç›´æ¥å¯åŠ¨ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
bash run_v18_embedding_rag.sh
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… åˆå§‹åŒ–æ—¶é—´ï¼š120 åˆ†é’Ÿï¼ˆèŠ‚çœ 40 åˆ†é’Ÿï¼‰
- âœ… Epoch 0 æ— å†·å¯åŠ¨å»¶è¿Ÿ
- âœ… æ¯ Epoch è€—æ—¶ï¼š40 åˆ†é’Ÿï¼ˆæ­£å¸¸ï¼‰

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¼˜åŒ–

1. âœ… **è°ƒæ•´ `_build_embedding_indexes` é€»è¾‘é¡ºåº**
   - å…ˆè®¡ç®— AFï¼Œå†ç”Ÿæˆ Mask
   - åˆå§‹åŒ–æ—¶ç›´æ¥ç”Ÿæˆ AF-Guided Mask

2. âœ… **æ¶ˆé™¤ Epoch 0 Cold Start**
   - èŠ‚çœ 40 åˆ†é’Ÿåˆå§‹åŒ–æ—¶é—´
   - Epoch 0 æ— éœ€ç­‰å¾…ï¼Œç›´æ¥å¼€å§‹è®­ç»ƒ

3. âœ… **ä¿æŒè®­ç»ƒæ­£ç¡®æ€§**
   - æ¯ Epoch ä»éœ€é‡å»ºç´¢å¼•ï¼ˆEnd-to-Endï¼‰
   - éªŒè¯é›†å›ºå®š 50% éš¾åº¦ï¼ˆæ­£ç¡®ï¼‰

### é¢„æœŸæ•ˆæœ

- ğŸ¯ **åˆå§‹åŒ–æ—¶é—´**: 160 åˆ†é’Ÿ â†’ 120 åˆ†é’Ÿ (**-25%**)
- ğŸ¯ **Epoch 0 å†·å¯åŠ¨**: 40 åˆ†é’Ÿ â†’ 0 åˆ†é’Ÿ (**-100%**)
- ğŸ¯ **ç´¢å¼•æ„å»ºæ¬¡æ•°**: 4 æ¬¡ â†’ 3 æ¬¡
- ğŸ¯ **è®­ç»ƒæ•ˆæœ**: å®Œå…¨ç›¸åŒï¼ˆAF-Guided Maskingï¼‰

**ç°åœ¨å¯ä»¥äº«å—æ›´å¿«çš„åˆå§‹åŒ–é€Ÿåº¦äº†ï¼ğŸš€**
