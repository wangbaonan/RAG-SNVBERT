# Validationé”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ› é‡åˆ°çš„é”™è¯¯

```
IndexError: index 0 is out of bounds for axis 0 with size 0
```

**é”™è¯¯åŸå› **ï¼šéªŒè¯é›†ï¼ˆTestMask30.vcf.gzï¼‰ä¸­çš„æŸäº›SNPä½ç‚¹åœ¨å‚è€ƒé¢æ¿ï¼ˆPanel.vcf.gzï¼‰ä¸­ä¸å­˜åœ¨ï¼Œå¯¼è‡´ç´¢å¼•æŸ¥æ‰¾å¤±è´¥ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### å·²ä¿®å¤çš„ä»£ç 

ä¿®æ”¹äº† `src/dataset/rag_train_dataset.py` çš„ `_build_faiss_indexes` æ–¹æ³•ï¼š

**ä¿®å¤å‰**ï¼ˆç¬¬83è¡Œï¼‰ï¼š
```python
ref_indices = [np.where(ref_pos == p)[0][0] for p in train_pos]
```
è¿™è¡Œä»£ç å‡è®¾æ‰€æœ‰ä½ç‚¹éƒ½åœ¨å‚è€ƒé¢æ¿ä¸­å­˜åœ¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°ä¼šæŠ›å‡ºIndexErrorã€‚

**ä¿®å¤å**ï¼š
```python
ref_indices = []
valid_pos_mask = []
for idx, p in enumerate(train_pos):
    matches = np.where(ref_pos == p)[0]
    if len(matches) > 0:
        ref_indices.append(matches[0])
        valid_pos_mask.append(idx)

# å¦‚æœæœ‰ä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­æ‰¾ä¸åˆ°ï¼Œéœ€è¦è¿‡æ»¤
if len(ref_indices) < len(train_pos):
    print(f"  âš  è­¦å‘Šï¼šçª—å£ {len(self.ref_data_windows)} ä¸­æœ‰ {len(train_pos) - len(ref_indices)}/{len(train_pos)} ä¸ªä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡")
    valid_indices = start + np.array(valid_pos_mask)
    if len(valid_indices) == 0:
        print(f"  âš  è·³è¿‡çª—å£ {len(self.ref_data_windows)}ï¼šæ²¡æœ‰å¯ç”¨çš„ä½ç‚¹")
        continue
    current_slice = valid_indices
```

**æ”¹è¿›**ï¼š
- âœ… å®‰å…¨åœ°æ£€æŸ¥æ¯ä¸ªä½ç‚¹æ˜¯å¦å­˜åœ¨äºå‚è€ƒé¢æ¿
- âœ… åªä½¿ç”¨å­˜åœ¨çš„ä½ç‚¹æ„å»ºFAISSç´¢å¼•
- âœ… è¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼Œå‘ŠçŸ¥æœ‰å¤šå°‘ä½ç‚¹è¢«è·³è¿‡
- âœ… å¦‚æœæ•´ä¸ªçª—å£éƒ½æ²¡æœ‰å¯ç”¨ä½ç‚¹ï¼Œç›´æ¥è·³è¿‡è¯¥çª—å£

---

## ğŸš€ ç°åœ¨å¦‚ä½•ä½¿ç”¨

### é€‰é¡¹1ï¼šä½¿ç”¨ä¿®å¤åçš„Validationè®­ç»ƒï¼ˆæ¨èï¼‰

```bash
cd /cpfs01/.../00_RAG-SNVBERT-packup

# æ‹‰å–æœ€æ–°ä¿®å¤
git pull origin main

# å‡†å¤‡éªŒè¯æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡åšï¼‰
python scripts/prepare_val_data.py \
    --test_dir /cpfs01/.../New_VCF/Test \
    --output_dir data/validation \
    --mask_ratios 30

# å¼€å§‹è®­ç»ƒï¼ˆä½¿ç”¨åŸå§‹è„šæœ¬ï¼‰
bash run_v11_with_val.sh
```

**è®­ç»ƒæ—¶ä½ ä¼šçœ‹åˆ°**ï¼š
```
Loading Validation Dataset...
å¤„ç†çª—å£: 1%|â–ˆ | 3/331 [00:00<00:15, 20.5it/s]
  âš  è­¦å‘Šï¼šçª—å£ 0 ä¸­æœ‰ 15/450 ä¸ªä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡
å¤„ç†çª—å£: 2%|â–ˆâ–ˆ| 6/331 [00:00<00:14, 22.3it/s]
...
âœ” æ‰€æœ‰çª—å£å¤„ç†å®Œæˆ | æ€»çª—å£æ•°=331
âœ“ Validation dataset: 324380 samples, 2535 batches
```

è¿™æ˜¯æ­£å¸¸çš„ï¼éƒ¨åˆ†ä½ç‚¹è¢«è·³è¿‡ä¸å½±å“è®­ç»ƒã€‚

---

### é€‰é¡¹2ï¼šä¸ä½¿ç”¨Validationï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœä½ æƒ³å…ˆæµ‹è¯•è®­ç»ƒèƒ½å¦æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥æš‚æ—¶ä¸ç”¨validationï¼š

```bash
# ä½¿ç”¨æ— validationç‰ˆæœ¬
bash run_v11_no_val.sh
```

è¿™ä¸ªè„šæœ¬å’Œä½ ä¹‹å‰çš„ `run_v10` ç±»ä¼¼ï¼Œä½†æœ‰æ”¹è¿›ï¼š
- âœ… RAG K=1ï¼ˆä»3é™åˆ°1ï¼ŒèŠ‚çœæ˜¾å­˜ï¼‰
- âœ… å‚æ•°å¤–éƒ¨åŒ–ï¼ˆä¸å†ç¡¬ç¼–ç ï¼‰
- âœ… å®Œæ•´çš„è®­ç»ƒæŒ‡æ ‡è¾“å‡º

---

## ğŸ” ä¸ºä»€ä¹ˆä¼šå‡ºç°SNPä¸åŒ¹é…ï¼Ÿ

### å¯èƒ½çš„åŸå› ï¼š

1. **è®­ç»ƒé›†å’Œæµ‹è¯•é›†æ¥æºä¸åŒ**
   - è®­ç»ƒé›†ï¼š`maf_data/KGP.chr21.Train.maf01.vcf.h5` ï¼ˆç»è¿‡MAFç­›é€‰ï¼‰
   - æµ‹è¯•é›†ï¼š`New_VCF/Test/Masked_VCFs/TestMask30.vcf.gz` ï¼ˆå¯èƒ½åŒ…å«æ›´å¤šSNPï¼‰

2. **MAFç­›é€‰é˜ˆå€¼ä¸åŒ**
   - `maf01` è¡¨ç¤ºMAF > 0.01çš„ç­›é€‰
   - æµ‹è¯•é›†å¯èƒ½æ²¡æœ‰è¿™ä¸ªç­›é€‰

3. **å‚è€ƒé¢æ¿ç‰ˆæœ¬ä¸åŒ**
   - å‚è€ƒé¢æ¿ï¼š`maf_data/KGP.chr21.Panel.maf01.vcf.gz`
   - å¦‚æœæµ‹è¯•é›†åŒ…å«æ–°çš„SNPï¼Œå‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨

### è§£å†³æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆAï¼šä½¿ç”¨ä¿®å¤åçš„ä»£ç **ï¼ˆå·²å®Œæˆï¼‰
- âœ… è‡ªåŠ¨è·³è¿‡ä¸å­˜åœ¨çš„SNP
- âœ… åªä½¿ç”¨å…±åŒçš„SNPè¿›è¡Œvalidation
- âœ… è¾“å‡ºè­¦å‘Šä½†ä¸ä¸­æ–­è®­ç»ƒ

**æ–¹æ¡ˆBï¼šé‡æ–°å‡†å¤‡æ•°æ®**ï¼ˆå¯é€‰ï¼Œå¦‚æœæƒ³è¦å®Œç¾åŒ¹é…ï¼‰
```bash
# 1. æå–è®­ç»ƒé›†å’Œå‚è€ƒé¢æ¿çš„å…±åŒSNP
bcftools isec -n=2 -w1 \
    maf_data/KGP.chr21.Train.maf01.vcf.gz \
    New_VCF/Test/Masked_VCFs/TestMask30.vcf.gz \
    -o data/test_intersect.vcf.gz

# 2. ç”¨intersectåçš„VCFä½œä¸ºéªŒè¯é›†
python scripts/prepare_val_data.py \
    --test_dir data/test_intersect.vcf.gz \
    --output_dir data/validation_clean
```

---

## ğŸ“Š é¢„æœŸè¡Œä¸º

### æ­£å¸¸æƒ…å†µï¼ˆå¤§éƒ¨åˆ†çª—å£æœ‰æ•ˆï¼‰ï¼š
```
å¤„ç†çª—å£: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [01:05<00:00, 5.1it/s]
  âš  è­¦å‘Šï¼šçª—å£ 12 ä¸­æœ‰ 5/450 ä¸ªä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡
  âš  è­¦å‘Šï¼šçª—å£ 45 ä¸­æœ‰ 8/450 ä¸ªä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡
...
âœ” æ‰€æœ‰çª—å£å¤„ç†å®Œæˆ | æ€»çª—å£æ•°=331
âœ“ Validation dataset: 320000+ samples
```
â†’ **å¯ä»¥ç»§ç»­è®­ç»ƒ**

### å¼‚å¸¸æƒ…å†µï¼ˆå¤§é‡çª—å£æ— æ•ˆï¼‰ï¼š
```
å¤„ç†çª—å£: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 331/331 [01:05<00:00, 5.1it/s]
  âš  è­¦å‘Šï¼šçª—å£ 0 ä¸­æœ‰ 450/450 ä¸ªä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨
  âš  è·³è¿‡çª—å£ 0ï¼šæ²¡æœ‰å¯ç”¨çš„ä½ç‚¹
  âš  è­¦å‘Šï¼šçª—å£ 1 ä¸­æœ‰ 450/450 ä¸ªä½ç‚¹åœ¨å‚è€ƒé¢æ¿ä¸­ä¸å­˜åœ¨
  âš  è·³è¿‡çª—å£ 1ï¼šæ²¡æœ‰å¯ç”¨çš„ä½ç‚¹
...
âœ” æ‰€æœ‰çª—å£å¤„ç†å®Œæˆ | æ€»çª—å£æ•°=50  â† å¤ªå°‘äº†ï¼
```
â†’ **å»ºè®®ä½¿ç”¨æ–¹æ¡ˆBé‡æ–°å‡†å¤‡æ•°æ®**

---

## âœ… æ£€æŸ¥æ¸…å•

é‡æ–°è®­ç»ƒå‰ç¡®è®¤ï¼š

- [x] å·²pullæœ€æ–°ä»£ç ï¼ˆåŒ…å«ä¿®å¤ï¼‰
- [ ] è¿è¡Œè®­ç»ƒè„šæœ¬
- [ ] è§‚å¯Ÿæ˜¯å¦æœ‰å¤§é‡"è·³è¿‡çª—å£"çš„è­¦å‘Š
- [ ] å¦‚æœå¤§éƒ¨åˆ†çª—å£æœ‰æ•ˆï¼Œç»§ç»­è®­ç»ƒ
- [ ] å¦‚æœå¤§éƒ¨åˆ†çª—å£è¢«è·³è¿‡ï¼Œè€ƒè™‘é‡æ–°å‡†å¤‡æ•°æ®

---

## ğŸ¯ æ€»ç»“

**çŸ­æœŸæ–¹æ¡ˆ**ï¼šä½¿ç”¨ä¿®å¤åçš„ä»£ç ï¼ˆå·²å®Œæˆï¼‰ï¼Œå…è®¸éƒ¨åˆ†SNPä¸åŒ¹é…

**é•¿æœŸæ–¹æ¡ˆ**ï¼šå¦‚æœéœ€è¦å®Œç¾çš„validationï¼Œå¯ä»¥ï¼š
1. ä½¿ç”¨ä¸è®­ç»ƒé›†å®Œå…¨ç›¸åŒSNPé›†åˆçš„æµ‹è¯•æ•°æ®
2. æˆ–è€…ä»è®­ç»ƒé›†ä¸­åˆ’åˆ†validationï¼ˆç”¨ `split_data.py`ï¼‰

**æ¨è**ï¼šå…ˆç”¨ä¿®å¤åçš„ä»£ç è®­ç»ƒï¼Œè§‚å¯Ÿæ•ˆæœã€‚å¦‚æœvalidationæŒ‡æ ‡åˆç†ï¼Œå°±ç»§ç»­ä½¿ç”¨ã€‚

ä¿®å¤å·²å®Œæˆï¼Œç°åœ¨å¯ä»¥é‡æ–°è¿è¡Œè®­ç»ƒäº†ï¼ğŸš€
